<!DOCTYPE html>
<html>
<head>
    <title>Teachable Machine → Spike Prime</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.20.0/dist/tf.min.js"></script>
</head>
<body>
    <h1>가위바위보 실습</h1>
    <video id="webcam" autoplay playsinline width="320" height="240"></video><br>
    <button id="loadBtn">모델 불러오기</button>
    <button id="connectBtn">Spike Prime 연결</button>
    <p id="status">상태: 대기 중</p>

    <script>
        let model;
        let port;
        let writer;

        const modelURL = "https://teachablemachine.withgoogle.com/models/XXXX/model.json"; // 여기에 본인 모델 URL

        async function initWebcam() {
            const webcam = document.getElementById('webcam');
            const stream = await navigator.mediaDevices.getUserMedia({video:true});
            webcam.srcObject = stream;
        }
        initWebcam();

        document.getElementById("loadBtn").addEventListener("click", async () => {
            try {
                model = await tf.loadGraphModel(https://teachablemachine.withgoogle.com/models/sywVZrxA4/);
                document.getElementById("status").innerText = "상태: 모델 불러오기 성공!";
            } catch (err) {
                alert("모델 불러오기 실패: " + err);
                console.error(err);
            }
        });

        document.getElementById("connectBtn").addEventListener("click", async () => {
            try {
                port = await navigator.serial.requestPort();
                await port.open({ baudRate: 115200 });
                writer = port.writable.getWriter();
                document.getElementById("status").innerText = "상태: Spike Prime 연결 완료!";
            } catch (err) {
                alert("연결 실패: " + err);
                console.error(err);
            }
        });

        setInterval(async () => {
            if (!model || !writer) return;
            const video = document.getElementById('webcam');
            const tensor = tf.browser.fromPixels(video).resizeBilinear([224,224]).expandDims(0).div(255);
            const prediction = model.predict(tensor);
            const data = prediction.dataSync();
            const maxIndex = data.indexOf(Math.max(...data));
            await writer.write(new TextEncoder().encode(maxIndex + "\n"));
        }, 1000);
    </script>
</body>
</html>
